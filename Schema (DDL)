-- Tables
CREATE TABLE users (
  user_id     SERIAL PRIMARY KEY,
  username    VARCHAR(50) NOT NULL UNIQUE,
  email       VARCHAR(255) NOT NULL UNIQUE,
  created_at  TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE tasks (
  task_id       SERIAL PRIMARY KEY,
  user_id       INT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  title         VARCHAR(200) NOT NULL,
  description   TEXT,
  status        VARCHAR(20) NOT NULL DEFAULT 'open', -- open, in_progress, done, cancelled
  priority      SMALLINT NOT NULL DEFAULT 3, -- 1 high .. 5 low
  due_at        TIMESTAMP WITH TIME ZONE,
  created_at    TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at    TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE tags (
  tag_id   SERIAL PRIMARY KEY,
  name     VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE task_tags (
  task_id INT NOT NULL REFERENCES tasks(task_id) ON DELETE CASCADE,
  tag_id  INT NOT NULL REFERENCES tags(tag_id) ON DELETE CASCADE,
  PRIMARY KEY (task_id, tag_id)
);

CREATE TABLE task_audit (
  audit_id   SERIAL PRIMARY KEY,
  task_id    INT NOT NULL,
  changed_by INT,
  change_ts  TIMESTAMP WITH TIME ZONE DEFAULT now(),
  old_status VARCHAR(20),
  new_status VARCHAR(20),
  note       TEXT
);
