CREATE OR REPLACE FUNCTION tasks_updated_at_trigger()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  NEW.updated_at := now();
  IF TG_OP = 'UPDATE' AND OLD.status IS DISTINCT FROM NEW.status THEN
    INSERT INTO task_audit(task_id, changed_by, old_status, new_status, note)
    VALUES (OLD.task_id, NULL, OLD.status, NEW.status, 'status changed');
  END IF;
  RETURN NEW;
END;
$$;

CREATE TRIGGER trg_tasks_updated_at
BEFORE UPDATE ON tasks
FOR EACH ROW EXECUTE FUNCTION tasks_updated_at_trigger();
